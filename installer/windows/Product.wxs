<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <?define ProductName = "Rikugan" ?>
  <?define ProductVersion = "1.0.0" ?>
  <?define ProductManufacturer = "Your Company" ?>
  <?define UpgradeCode = "12345678-1234-1234-1234-123456789ABC" ?>

  <Product Id="*"
           Name="$(var.ProductName)"
           Language="1033"
           Version="$(var.ProductVersion)"
           Manufacturer="$(var.ProductManufacturer)"
           UpgradeCode="$(var.UpgradeCode)">

    <Package InstallerVersion="500"
             Compressed="yes"
             InstallScope="perMachine"
             Description="$(var.ProductName) Installer"
             Comments="Remote management and monitoring agent" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Properties for configuration -->
    <Property Id="SERVER_URL" Value="" />
    <Property Id="AGENT_TOKEN" Value="" />
    <Property Id="AGENT_ID" Value="" />
    
    <!-- Features -->
    <Feature Id="ProductFeature" Title="Rikugan Agent" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="ServiceComponents" />
    </Feature>

    <!-- UI for collecting server URL and token -->
    <UI>
      <UIRef Id="WixUI_Mondo" />
      <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="StartService">INSTALLED</Publish>
    </UI>

    <!-- Custom action to start service after install -->
    <CustomAction Id="StartService"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[SystemFolder]sc.exe start RikuganAgent"
                  Execute="deferred"
                  Return="ignore"
                  Impersonate="no" />

    <InstallExecuteSequence>
      <Custom Action="StartService" After="StartServices">NOT Installed</Custom>
    </InstallExecuteSequence>

  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="Rikugan">
          <Directory Id="SYNCFOLDER" Name="sync" />
          <Directory Id="LOGSFOLDER" Name="logs" />
        </Directory>
      </Directory>
    </Directory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="MainExecutable" Guid="11111111-1111-1111-1111-111111111111" Win64="yes">
        <File Id="RikuganExe"
              Source="$(var.BuildDir)\rikugan.exe"
              KeyPath="yes" />
      </Component>
      
      <Component Id="ConfigFile" Guid="22222222-2222-2222-2222-222222222222" Win64="yes">
        <File Id="ConfigYaml"
              Source="$(var.BuildDir)\agent-config.yaml"
              KeyPath="yes" />
      </Component>
      
      <Component Id="SyncFolder" Guid="33333333-3333-3333-3333-333333333333" Win64="yes">
        <CreateFolder Directory="SYNCFOLDER" />
      </Component>
      
      <Component Id="LogsFolder" Guid="44444444-4444-4444-4444-444444444444" Win64="yes">
        <CreateFolder Directory="LOGSFOLDER" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="ServiceComponents" Directory="INSTALLFOLDER">
      <Component Id="ServiceInstaller" Guid="55555555-5555-5555-5555-555555555555" Win64="yes">
        <File Id="ServiceExe"
              Source="$(var.BuildDir)\rikugan.exe"
              KeyPath="yes"
              Name="rikugan-svc.exe" />
        
        <ServiceInstall Id="ServiceInstaller"
                        Type="ownProcess"
                        Name="RikuganAgent"
                        DisplayName="Rikugan Agent"
                        Description="Remote management and monitoring agent service"
                        Start="auto"
                        Account="LocalSystem"
                        ErrorControl="normal"
                        Arguments="-agent -server-url &quot;[SERVER_URL]&quot; -token &quot;[AGENT_TOKEN]&quot; -agent-id &quot;[AGENT_ID]&quot; -sync-dir &quot;[INSTALLFOLDER]sync&quot;">
          <ServiceDependency Id="Tcpip" />
        </ServiceInstall>
        
        <ServiceControl Id="StartService"
                        Start="install"
                        Stop="both"
                        Remove="uninstall"
                        Name="RikuganAgent"
                        Wait="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

</Wix>
